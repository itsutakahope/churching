<script>
// ==================== 全域變數 ====================
let requirements = [];
let filteredRequirements = [];
let currentView = 'list'; // 'list' 或 'grid'
let isLoading = false;

// ==================== 深色模式 ====================
function initTheme() {
  const themeToggle = document.getElementById('themeToggle');

  // 檢查本地儲存的主題偏好
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
  }

  themeToggle.addEventListener('click', function() {
    if (document.documentElement.classList.contains('dark')) {
      document.documentElement.classList.remove('dark');
      localStorage.theme = 'light';
    } else {
      document.documentElement.classList.add('dark');
      localStorage.theme = 'dark';
    }
  });
}

// ==================== 使用者選單 ====================
function initUserMenu() {
  const menuButton = document.getElementById('userMenuButton');
  const menu = document.getElementById('userMenu');

  menuButton.addEventListener('click', function(e) {
    e.stopPropagation();
    menu.classList.toggle('hidden');
  });

  // 點擊外部關閉選單
  document.addEventListener('click', function() {
    menu.classList.add('hidden');
  });
}

// ==================== Toast 通知 ====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');

  const icons = {
    success: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>',
    error: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>',
    info: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>',
    warning: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>'
  };

  toast.className = `toast toast-${type} p-4 flex items-start`;
  toast.innerHTML = `
    <div class="flex-shrink-0 text-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-500">
      ${icons[type]}
    </div>
    <div class="ml-3 flex-1">
      <p class="text-sm font-medium text-gray-900 dark:text-white">${message}</p>
    </div>
    <button onclick="this.parentElement.remove()" class="ml-4 flex-shrink-0">
      <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
    </button>
  `;

  container.appendChild(toast);

  // 自動移除
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

// ==================== API 呼叫 ====================
function callAPI(action, data = {}) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .handleAPIRequest({ action, data });
  });
}

// 為了讓 google.script.run 正常工作，我們需要在後端建立一個路由函式
// 在 WebApp.gs 中新增：
// function handleAPIRequest(request) {
//   return doPost({ postData: { contents: JSON.stringify(request) } });
// }

// 載入採購申請
async function loadRequirements() {
  try {
    isLoading = true;
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('requirementsList').classList.add('hidden');
    document.getElementById('noData').classList.add('hidden');

    const response = await callAPI('getRequirements', {
      filters: {
        searchText: document.getElementById('searchInput').value,
        status: document.getElementById('statusFilter').value || undefined,
        priority: document.getElementById('priorityFilter').value || undefined
      },
      sort: {
        field: 'createdAt',
        order: 'desc'
      },
      pagination: {
        page: 1,
        pageSize: 100
      }
    });

    if (response.success) {
      requirements = response.data.data || [];
      filteredRequirements = requirements;
      renderRequirements();
    } else {
      throw new Error(response.error.message);
    }
  } catch (error) {
    console.error('載入採購申請失敗:', error);
    showToast('載入資料失敗: ' + error.message, 'error');
  } finally {
    isLoading = false;
    document.getElementById('loading').classList.add('hidden');
  }
}

// ==================== 渲染採購申請列表 ====================
function renderRequirements() {
  const container = document.getElementById('requirementsList');

  if (filteredRequirements.length === 0) {
    container.classList.add('hidden');
    document.getElementById('noData').classList.remove('hidden');
    return;
  }

  container.classList.remove('hidden');
  document.getElementById('noData').classList.add('hidden');

  if (currentView === 'grid') {
    container.className = 'grid-view';
    container.innerHTML = filteredRequirements.map(req => renderRequirementCard(req)).join('');
  } else {
    container.className = 'list-view';
    container.innerHTML = filteredRequirements.map(req => renderRequirementListItem(req)).join('');
  }
}

// 渲染卡片視圖
function renderRequirementCard(req) {
  const statusClass = {
    pending: 'badge-pending',
    purchased: 'badge-purchased',
    cancelled: 'badge-cancelled'
  }[req.status] || 'badge-pending';

  const statusText = {
    pending: '待購買',
    purchased: '已購買',
    cancelled: '已取消'
  }[req.status] || '待購買';

  const priorityClass = req.priority === 'urgent' ? 'badge-urgent' : 'badge-normal';
  const priorityText = req.priority === 'urgent' ? '緊急' : '一般';

  return `
    <div class="requirement-card bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-5 fade-in">
      <!-- 標題和狀態 -->
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex-1">${escapeHtml(req.text)}</h3>
        <span class="badge ${statusClass} ml-2">${statusText}</span>
      </div>

      <!-- 規格說明 -->
      ${req.description ? `
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${escapeHtml(req.description)}</p>
      ` : ''}

      <!-- 詳細資訊 -->
      <div class="space-y-2 text-sm mb-4">
        <div class="flex items-center text-gray-600 dark:text-gray-400">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          <span>${escapeHtml(req.requesterName)}</span>
        </div>
        <div class="flex items-center text-gray-600 dark:text-gray-400">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          <span>${escapeHtml(req.accountingCategory)}</span>
        </div>
        <div class="flex items-center">
          <span class="badge ${priorityClass}">${priorityText}</span>
        </div>
      </div>

      <!-- 購買資訊（如果已購買） -->
      ${req.status === 'purchased' ? `
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 mb-4 text-sm">
          <div class="font-semibold text-green-800 dark:text-green-300 mb-1">購買資訊</div>
          <div class="text-green-700 dark:text-green-400 space-y-1">
            <div>金額: NT$ ${req.purchaseAmount}</div>
            <div>購買人: ${escapeHtml(req.purchaserName)}</div>
            <div>日期: ${req.purchaseDate}</div>
          </div>
        </div>
      ` : ''}

      <!-- 操作按鈕 -->
      <div class="flex gap-2">
        ${req.status === 'pending' && req.userId === currentUser.id ? `
          <button onclick="openEditModal('${req.id}')" class="btn btn-sm btn-secondary flex-1">
            編輯
          </button>
          <button onclick="deleteRequirement('${req.id}')" class="btn btn-sm btn-danger flex-1">
            刪除
          </button>
        ` : ''}
        ${req.status === 'pending' ? `
          <button onclick="openPurchaseModal('${req.id}')" class="btn btn-sm btn-success flex-1">
            標記已購買
          </button>
        ` : ''}
        <button onclick="openDetailModal('${req.id}')" class="btn btn-sm btn-primary flex-1">
          查看詳情
        </button>
      </div>
    </div>
  `;
}

// 渲染列表視圖
function renderRequirementListItem(req) {
  const statusClass = {
    pending: 'badge-pending',
    purchased: 'badge-purchased',
    cancelled: 'badge-cancelled'
  }[req.status] || 'badge-pending';

  const statusText = {
    pending: '待購買',
    purchased: '已購買',
    cancelled: '已取消'
  }[req.status] || '待購買';

  return `
    <div class="requirement-card bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 fade-in">
      <div class="flex items-center justify-between">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-3 mb-2">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate">${escapeHtml(req.text)}</h3>
            <span class="badge ${statusClass}">${statusText}</span>
            ${req.priority === 'urgent' ? '<span class="badge badge-urgent">緊急</span>' : ''}
          </div>
          <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
            <span>${escapeHtml(req.requesterName)}</span>
            <span>•</span>
            <span>${escapeHtml(req.accountingCategory)}</span>
            <span>•</span>
            <span>${formatDate(req.createdAt)}</span>
            ${req.status === 'purchased' ? `
              <span>•</span>
              <span class="text-green-600 dark:text-green-400">NT$ ${req.purchaseAmount}</span>
            ` : ''}
          </div>
        </div>
        <div class="flex items-center gap-2 ml-4">
          ${req.status === 'pending' && req.userId === currentUser.id ? `
            <button onclick="openEditModal('${req.id}')" class="btn btn-sm btn-secondary" title="編輯">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
          ` : ''}
          ${req.status === 'pending' ? `
            <button onclick="openPurchaseModal('${req.id}')" class="btn btn-sm btn-success" title="標記已購買">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </button>
          ` : ''}
          <button onclick="openDetailModal('${req.id}')" class="btn btn-sm btn-primary" title="查看詳情">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `;
}

// ==================== 工具函式 ====================
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
}

function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

// ==================== 視圖切換 ====================
function initViewToggle() {
  const listBtn = document.getElementById('listViewBtn');
  const gridBtn = document.getElementById('gridViewBtn');

  listBtn.addEventListener('click', function() {
    currentView = 'list';
    listBtn.classList.add('bg-white', 'dark:bg-gray-600', 'shadow-sm');
    listBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
    gridBtn.classList.remove('bg-white', 'dark:bg-gray-600', 'shadow-sm');
    gridBtn.classList.add('text-gray-500', 'dark:text-gray-400');
    renderRequirements();
  });

  gridBtn.addEventListener('click', function() {
    currentView = 'grid';
    gridBtn.classList.add('bg-white', 'dark:bg-gray-600', 'shadow-sm');
    gridBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
    listBtn.classList.remove('bg-white', 'dark:bg-gray-600', 'shadow-sm');
    listBtn.classList.add('text-gray-500', 'dark:text-gray-400');
    renderRequirements();
  });
}

// ==================== 搜尋和篩選 ====================
function initFilters() {
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const priorityFilter = document.getElementById('priorityFilter');

  // 防抖函式
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadRequirements(), 300);
  });

  statusFilter.addEventListener('change', loadRequirements);
  priorityFilter.addEventListener('change', loadRequirements);
}

// ==================== 初始化應用程式 ====================
function initializeApp() {
  initTheme();
  initUserMenu();
  initViewToggle();
  initFilters();
  loadRequirements();
}

// ==================== 模態框函式（將在下一個檔案實作） ====================
function openNewRequirementModal() {
  showToast('新增採購需求功能開發中...', 'info');
}

function openEditModal(id) {
  showToast('編輯功能開發中...', 'info');
}

function openPurchaseModal(id) {
  showToast('標記已購買功能開發中...', 'info');
}

function openDetailModal(id) {
  showToast('查看詳情功能開發中...', 'info');
}

async function deleteRequirement(id) {
  if (!confirm('確定要刪除這個採購需求嗎？')) return;

  try {
    const response = await callAPI('deleteRequirement', { id });
    if (response.success) {
      showToast('刪除成功！', 'success');
      loadRequirements();
    } else {
      throw new Error(response.error.message);
    }
  } catch (error) {
    showToast('刪除失敗: ' + error.message, 'error');
  }
}

function openPreferences() {
  showToast('偏好設定功能開發中...', 'info');
}
</script>
